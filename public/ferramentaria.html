<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Ferramentaria</title>
  <link rel="icon" type="image/x-icon" href="./icone.ico">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f5f7;
      margin: 0;
      font-size: 13px;
      display: flex;
    }
    .sidebar {
      width: 220px;
      background: #fff;
      color: #222e3c;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 24px 0 0 0;
      box-shadow: 2px 0 8px rgba(0,0,0,0.08);
      z-index: 10;
      transition: width 0.3s;
      overflow: hidden;
    }
    .sidebar.closed {
      width: 60px;
    }
    .sidebar .logo {
      width: 100%;
      text-align: center;
      margin-bottom: 24px;
      transition: all 0.3s;
    }
    .sidebar .logo img {
      width: 140px;
      transition: width 0.3s, opacity 0.3s;
    }
    .sidebar.closed .logo img {
      display: none;
    }
    .sidebar nav {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-left: 24px;
      transition: all 0.3s;
    }
    .sidebar a {
      color: #222e3c;
      text-decoration: none;
      font-size: 15px;
      padding: 6px 0;
      border-radius: 4px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
    }
    .sidebar a:hover {
      background: #f4f5f7;
    }
    .sidebar a img {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      filter: grayscale(100%);
      transition: margin 0.3s, width 0.3s, height 0.3s;
    }
    .sidebar.closed nav {
      margin-left: 0;
      align-items: center;
    }
    .sidebar.closed nav a {
      justify-content: center;
      font-size: 0;
      padding: 8px 0;
    }
    .sidebar.closed nav a img {
      margin: 0;
      width: 24px;
      height: 24px;
      filter: grayscale(0%);
    }
    .sidebar-toggle {
      margin-top: auto;
      width: 100%;
      background: none;
      border: none;
      color: #222e3c;
      font-size: 22px;
      cursor: pointer;
      padding: 12px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      position: absolute;
      left: 0;
      bottom: 32px;
      border-radius: 0 0 0 8px;
    }
    .sidebar-toggle:hover {
      background: #f4f5f7;
    }
    .sidebar.closed .sidebar-toggle {
      width: 60px;
    }
    .main-content {
      margin-left: 220px;
      width: calc(100vw - 220px);
      padding: 20px;
      transition: margin-left 0.3s, width 0.3s;
    }
    .sidebar.closed ~ .main-content {
      margin-left: 60px;
      width: calc(100vw - 60px);
    }
    h2 {
      margin-bottom: 10px;
      font-size: 18px;
    }
    /* Tabela Ferramentaria */
    .ferramentaria-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      border-radius: 12px;
      overflow: hidden;
    }
    .ferramentaria-table thead tr {
      background: linear-gradient(90deg, #007bff 0%, #00c2e0 100%);
    }
    .ferramentaria-table th {
      color: #fff;
      font-weight: bold;
      padding: 12px 14px;
      font-size: 15px;
      border: none;
    }
    .ferramentaria-table th:first-child {
      border-top-left-radius: 12px;
    }
    .ferramentaria-table th:last-child {
      border-top-right-radius: 12px;
    }
    .ferramentaria-table td {
      border: 1px solid #e0e0e0;
      padding: 10px 12px;
      font-size: 14px;
      color: #222;
      background: #fff;
      text-align: center;
      height: 32px;
    }
    .ferramentaria-table tr:not(:last-child) td {
      border-bottom: 1px solid #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="sidebar closed" id="sidebar">
    <div class="logo">
      <img src="./logo.png" alt="Logo">
    </div>
    <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 0 24px 18px 24px;">
    <nav>
      <a href="./index.html">
        <img src="./icons/house-chimney.svg" alt="Dashboard">
        <span>Início</span>
      </a>
      <a href="./producao.html" id="producaoLink">
        <img src="./icons/industry-windows.svg" alt="Dashboard">
        <span>Painel Fabrica</span>
      </a>
      <a href="./ferramentaria.html">
        <img src="./icons/robotic-arm.svg" alt="Dashboard">
        <span>Ferramentaria</span>
      </a>
      <a href="./vendas.html" id="vendasLink">
        <img src="./icons/search-dollar.svg" alt="Relatórios">
        <span>Vendas</span>
      </a>
    </nav>
    <button class="sidebar-toggle" id="sidebarToggle" title="Abrir/Fechar menu">
      <span id="toggleIcon">&gt;</span>
    </button>
  </div>
  <div class="main-content" id="mainContent">
    <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 10px; justify-content: space-between; position: relative;">
        <img src="logo.png" alt="Logo" style="height: 58px; margin-right: 18px; margin-left: 0;" />
        <div style="display: flex; align-items: center; gap: 8px;">
          <input id="searchBar" type="text" placeholder="Pesquisar código ou descrição..." style="padding: 8px 14px; font-size: 15px; border: 1px solid #ccc; border-radius: 6px; width: 240px;" autocomplete="off">
          <div id="suggestions" style="position: absolute; z-index: 10; background: #fff; border: 1px solid #ccc; border-radius: 0 0 6px 6px; width: 240px; max-height: 180px; overflow-y: auto; display: none;"></div>
          <button id="btnSearch" style="padding: 8px 18px; font-size: 15px; border: none; border-radius: 6px; background: #0079bf; color: #fff; font-weight: bold; cursor: pointer; margin-right: 8px;">Buscar</button>
        </div>
    </div>
    <h2>Ferramentaria</h2>
    <div style="max-width: 1000px; margin: 0 auto 18px auto; display: flex; justify-content: flex-end; align-items: center; gap: 12px;">
  <button id="btnNovo" style="padding: 8px 18px; font-size: 15px; border: none; border-radius: 6px; background: #28a745; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.2s;">Novo</button>
  <button id="btnImprimir" style="padding: 8px 18px; font-size: 15px; border: none; border-radius: 6px; background: #007bff; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.2s;">Imprimir</button>
    </div>
    <div style="overflow-x:auto; margin-top: 24px;">
  <button id="btnImprimirOrdem" style="padding: 8px 18px; font-size: 15px; border: none; border-radius: 6px; background: #ffc107; color: #222; font-weight: bold; cursor: pointer; transition: background 0.2s; margin-bottom: 12px;">Imprimir Ordem</button>
  <table class="ferramentaria-table" id="tabelaFerramentaria">
        <thead>
          <tr>
            <th>N° OS</th>
            <th>Data Abertura</th>
            <th>Cod. Peça</th>
            <th>N° Molde</th>
            <th>Obs</th>
            <th>Setor Solicitante</th>
            <th>Data Limite Entrega</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
    <div id="containerSalvar" style="max-width: 1000px; margin: 18px auto 0 auto; display: flex; justify-content: flex-end; align-items: center;">
    </div>
  </div>
  <script>
    // Botão imprimir ordem de produção (primeira linha)
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('btnImprimirOrdem').addEventListener('click', function() {
        const tabela = document.getElementById('tabelaFerramentaria');
        const primeiraLinha = tabela.querySelector('tbody tr');
        if (!primeiraLinha) {
          alert('Nenhum registro para imprimir!');
          return;
        }
        const dados = Array.from(primeiraLinha.children).map(td => td.innerText);
        // Novo layout fornecido pelo usuário
        const html = `
<html>
<head>
  <title>Ordem de Serviço Manutenção</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 12px; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #000; padding: 4px 6px; font-size: 13px; vertical-align: middle; }
    .titulo { text-align: center; font-size: 18px; font-weight: bold; }
    .cabecalho td { height: 30px; }
    .classe-tipo-table { width: 65%; margin-top: 12px; }
    .classe-tipo-table th, .classe-tipo-table td { text-align: left; }
    .tick { width: 16px; height: 16px; display: inline-block; border: 1px solid #000; }
    .obs { border: 1px solid #000; height: 280px; margin-top: 12px; padding: 8px; font-size: 13px; }
    .descricao { border: 1px solid #000; height: 100px; margin-top: 12px; padding: 8px; font-size: 13px; }
    .assinaturas { margin-top: 12px; width: 100%; }
    .assinaturas td { height: 36px; padding: 8px; }
    .data-criacao-block { width: 30%; float: right; margin-top: 12px; }
    .clear { clear: both; }
  </style>
</head>
<body>
  <!-- CABEÇALHO -->
  <table class="cabecalho">
    <tr style="height: 60px;">
      <td style="width: 80px; text-align:center; vertical-align:middle;">
        <img src='./logo.png' alt='Logo' style='max-width:70px; max-height:32px; display:block; margin:auto;'>
      </td>
      <td class="titulo" colspan="3">Ordem de Serviço Manutenção</td>
      <td style="width: 80px;">OS: ${dados[0] || ''}</td>
    </tr>
    <tr>
      <td colspan="2">Solicitante: ${dados[5] || ''}</td>
      <td style="width: 25%;">Produto: ${dados[2] || ''}</td>
      <td></td>
    </tr>
  </table>

  <!-- CLASSE e TIPO lado a lado, com espaçamento e título ocupando duas colunas -->
  <div style="display: flex; gap: 32px; margin-top: 12px;">
  <table style="min-width: 140px; max-width: 180px; width: 22%; border-collapse: collapse; align-self: flex-start;">
      <tr>
        <th colspan="2" style="text-align: center;">Classe</th>
      </tr>
      <tr>
        <td style="width:28px;text-align:center;"><span class="tick"></span></td><td>Elétrica</td>
      </tr>
      <tr>
        <td style="width:28px;text-align:center;"><span class="tick"></span></td><td>Mecânica</td>
      </tr>
      <tr>
        <td style="width:28px;text-align:center;"><span class="tick"></span></td><td>Hidráulica</td>
      </tr>
      <tr>
        <td style="width:28px;text-align:center;"><span class="tick"></span></td><td>Pneumática</td>
      </tr>
    </table>
  <table style="min-width: 140px; max-width: 180px; width: 22%; border-collapse: collapse; align-self: flex-start;">
      <tr>
        <th colspan="2" style="text-align: center;">Tipo</th>
      </tr>
      <tr>
        <td style="width:28px;text-align:center;"><span class="tick"></span></td><td>Corretiva</td>
      </tr>
      <tr>
        <td style="width:28px;text-align:center;"><span class="tick"></span></td><td>Preventiva</td>
      </tr>
      <tr>
        <td style="width:28px;text-align:center;"><span class="tick"></span></td><td>Predial</td>
      </tr>
      <tr>
        <td style="width:28px;text-align:center;"><span class="tick"></span></td><td></td>
      </tr>
    </table>
    <div class="data-criacao-block" style="width: 20%; margin-left: auto; align-self: flex-end;">
      <table style="width: 100%;">
        <tr>
          <th style="text-align: center;">Data de Criação</th>
        </tr>
        <tr>
          <td style="text-align: center;">${dados[1] || ''}</td>
        </tr>
      </table>
    </div>
  </div>
  <div class="clear"></div>

  <table style="margin-top: 12px; width: 30%; height: 50px;">
    <tr>
      <td style="width: 25%;">Molde: ${dados[3] || ''}</td>
    </tr>
  </table>

  <div class="descricao">
    <b>Descrição:</b><br><br>${dados[4] || ''}
  </div>        

  <!-- OBSERVAÇÃO -->
  <div class="obs">
    <b>Observação:</b><br><br>
  </div>

  <!-- RODAPÉ: Molde / Responsável / Início / Fim -->
  <table class="assinaturas">
    <tr>
      <td style="width: 30%;">Responsável: __________________</td>
    </tr>
  </table>
  <table style="margin-top: 12px; width: 80%;">
    <tr>
      <td style="width: 20%; height: 50px;">Início da Manutenção: ___/___/____</td>
      <td style="width: 25%;">Fim da Manutenção: ___/___/____</td>
    </tr>
  </table>
    <img src='./FOTO FERRAMENTARIA.png' alt='Logo' style='max-width:200px; display:block; margin-top:24px; margin:auto;'>
</body>
</html>
        `;
        const win = window.open('', '', 'width=900,height=700');
        win.document.write(html);
        win.document.close();
        setTimeout(function() {
          win.print();
        }, 1000);
      });
    });
    // Botão imprimir: imprime apenas a tabela de ferramentaria
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('btnImprimir').addEventListener('click', function() {
        const tabela = document.getElementById('tabelaFerramentaria');
        const win = window.open('', '', 'width=900,height=600');
        win.document.write('<html><head><title>Impressão Ferramentaria</title>');
        win.document.write('<style>body{font-family:Arial,sans-serif;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:8px;text-align:center;}th{background:#007bff;color:#fff;}</style>');
        win.document.write('</head><body >');
        win.document.write('<h2>Ferramentaria</h2>');
        win.document.write(tabela.outerHTML);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
      });
    });
    // Buscar e exibir registros salvos ao carregar a página
    window.addEventListener('DOMContentLoaded', function() {
      fetch('/api/ferramentaria')
        .then(res => res.json())
        .then(registros => {
          const tabela = document.getElementById('tabelaFerramentaria').getElementsByTagName('tbody')[0];
          tabela.innerHTML = '';
          registros.forEach(dados => {
            const linha = document.createElement('tr');
            linha.innerHTML = [
              `<td>${dados.os || ''}</td>`,
              `<td>${dados.abertura || ''}</td>`,
              `<td>${dados.peca || ''}</td>`,
              `<td>${dados.molde || ''}</td>`,
              `<td><button class='btnAbrirObs' style='padding:6px 12px;font-size:14px;border:none;border-radius:6px;background:#ffc107;color:#222;font-weight:bold;cursor:pointer;'>Abrir</button></td>`,
              `<td>${dados.setor || ''}</td>`,
              `<td>${dados.limite || ''}</td>`,
              `<td>${dados.status || ''}</td>`
            ].join('');
            tabela.appendChild(linha);
            // Evento para abrir observação
            const btnAbrirObs = linha.querySelector('.btnAbrirObs');
            if (btnAbrirObs) {
              btnAbrirObs.addEventListener('click', function() {
                let modal = document.getElementById('modalObs');
                if (!modal) {
                  modal = document.createElement('div');
                  modal.id = 'modalObs';
                  modal.style.position = 'fixed';
                  modal.style.top = '0';
                  modal.style.left = '0';
                  modal.style.width = '100vw';
                  modal.style.height = '100vh';
                  modal.style.background = 'rgba(0,0,0,0.3)';
                  modal.style.display = 'flex';
                  modal.style.alignItems = 'center';
                  modal.style.justifyContent = 'center';
                  modal.style.zIndex = '9999';
                  const box = document.createElement('div');
                  box.style.background = '#fff';
                  box.style.borderRadius = '12px';
                  box.style.padding = '24px';
                  box.style.boxShadow = '0 2px 16px rgba(0,0,0,0.18)';
                  box.style.minWidth = '540px';
                  box.style.maxWidth = '98vw';
                  box.style.display = 'flex';
                  box.style.flexDirection = 'column';
                  box.style.gap = '16px';
                  const label = document.createElement('label');
                  label.textContent = 'Observação:';
                  label.style.fontWeight = 'bold';
                  label.style.marginBottom = '8px';
                  const textoObs = document.createElement('div');
                  textoObs.style.width = '100%';
                  textoObs.style.minHeight = '120px';
                  textoObs.style.fontSize = '15px';
                  textoObs.style.padding = '8px';
                  textoObs.style.borderRadius = '6px';
                  textoObs.style.border = '1px solid #ccc';
                  textoObs.style.background = '#f8f9fa';
                  textoObs.style.whiteSpace = 'pre-wrap';
                  textoObs.textContent = dados.obs || '';
                  const btnFecharObs = document.createElement('button');
                  btnFecharObs.textContent = 'Fechar';
                  btnFecharObs.style.padding = '8px 18px';
                  btnFecharObs.style.fontSize = '15px';
                  btnFecharObs.style.border = 'none';
                  btnFecharObs.style.borderRadius = '6px';
                  btnFecharObs.style.background = '#dc3545';
                  btnFecharObs.style.color = '#fff';
                  btnFecharObs.style.fontWeight = 'bold';
                  btnFecharObs.style.cursor = 'pointer';
                  btnFecharObs.style.transition = 'background 0.2s';
                  btnFecharObs.style.marginLeft = '10px';
                  const btns = document.createElement('div');
                  btns.style.display = 'flex';
                  btns.style.justifyContent = 'flex-end';
                  btns.appendChild(btnFecharObs);
                  box.appendChild(label);
                  box.appendChild(textoObs);
                  box.appendChild(btns);
                  modal.appendChild(box);
                  document.body.appendChild(modal);
                  btnFecharObs.onclick = () => modal.remove();
                }
              });
            }
          });
        })
        .catch(() => {
          // Se der erro, não faz nada
        });
    });
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggle');
    const toggleIcon = document.getElementById('toggleIcon');
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('closed');
      toggleIcon.innerHTML = sidebar.classList.contains('closed') ? '&gt;' : '&lt;';
    });

    // Adiciona funcionalidade ao botão Novo
    document.getElementById('btnNovo').addEventListener('click', function() {
      const tabela = document.getElementById('tabelaFerramentaria').getElementsByTagName('tbody')[0];
      // Evita múltiplas linhas abertas
      if (document.getElementById('linhaNova')) return;
      const linha = document.createElement('tr');
      linha.id = 'linhaNova';
      const campos = ['os', 'abertura', 'peca', 'molde', 'obs', 'setor', 'limite', 'status'];
      campos.forEach((campo, idx) => {
        const td = document.createElement('td');
        if (campo === 'obs') {
          // Botão para abrir bloco de notas
          const btnObs = document.createElement('button');
          btnObs.textContent = 'Adicionar';
          btnObs.style.padding = '6px 12px';
          btnObs.style.fontSize = '14px';
          btnObs.style.border = 'none';
          btnObs.style.borderRadius = '6px';
          btnObs.style.background = '#ffc107';
          btnObs.style.color = '#222';
          btnObs.style.fontWeight = 'bold';
          btnObs.style.cursor = 'pointer';
          btnObs.style.transition = 'background 0.2s';
          td.appendChild(btnObs);
          // Modal bloco de notas
          btnObs.addEventListener('click', function() {
            let modal = document.getElementById('modalObs');
            if (!modal) {
              modal = document.createElement('div');
              modal.id = 'modalObs';
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100vw';
              modal.style.height = '100vh';
              modal.style.background = 'rgba(0,0,0,0.3)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';
              // Conteúdo do modal
              const box = document.createElement('div');
              box.style.background = '#fff';
              box.style.borderRadius = '12px';
              box.style.padding = '24px';
              box.style.boxShadow = '0 2px 16px rgba(0,0,0,0.18)';
              box.style.minWidth = '540px';
              box.style.maxWidth = '98vw';
              box.style.display = 'flex';
              box.style.flexDirection = 'column';
              box.style.gap = '16px';
              const label = document.createElement('label');
              label.textContent = 'Observação:';
              label.style.fontWeight = 'bold';
              label.style.marginBottom = '8px';
              const textarea = document.createElement('textarea');
              textarea.style.width = '100%';
              textarea.style.height = '220px';
              textarea.style.fontSize = '15px';
              textarea.style.padding = '8px';
              textarea.style.borderRadius = '6px';
              textarea.style.border = '1px solid #ccc';
              textarea.style.resize = 'vertical';
              textarea.value = btnObs.dataset.obs || '';
              const btnSalvarObs = document.createElement('button');
              btnSalvarObs.textContent = 'Salvar Obs';
              btnSalvarObs.style.padding = '8px 18px';
              btnSalvarObs.style.fontSize = '15px';
              btnSalvarObs.style.border = 'none';
              btnSalvarObs.style.borderRadius = '6px';
              btnSalvarObs.style.background = '#007bff';
              btnSalvarObs.style.color = '#fff';
              btnSalvarObs.style.fontWeight = 'bold';
              btnSalvarObs.style.cursor = 'pointer';
              btnSalvarObs.style.transition = 'background 0.2s';
              btnSalvarObs.style.marginRight = '10px';
              const btnFecharObs = document.createElement('button');
              btnFecharObs.textContent = 'Fechar';
              btnFecharObs.style.padding = '8px 18px';
              btnFecharObs.style.fontSize = '15px';
              btnFecharObs.style.border = 'none';
              btnFecharObs.style.borderRadius = '6px';
              btnFecharObs.style.background = '#dc3545';
              btnFecharObs.style.color = '#fff';
              btnFecharObs.style.fontWeight = 'bold';
              btnFecharObs.style.cursor = 'pointer';
              btnFecharObs.style.transition = 'background 0.2s';
              btnFecharObs.style.marginLeft = '10px';
              const btns = document.createElement('div');
              btns.style.display = 'flex';
              btns.style.justifyContent = 'flex-end';
              btns.appendChild(btnSalvarObs);
              btns.appendChild(btnFecharObs);
              box.appendChild(label);
              box.appendChild(textarea);
              box.appendChild(btns);
              modal.appendChild(box);
              document.body.appendChild(modal);
              btnFecharObs.onclick = () => modal.remove();
              btnSalvarObs.onclick = () => {
                btnObs.dataset.obs = textarea.value;
                btnObs.textContent = textarea.value ? 'Ok' : 'Adicionar Obs';
                modal.remove();
              };
            }
          });
        } else if (campo === 'limite') {
          let input = document.createElement('input');
          input.type = 'date';
          input.style.width = '100%';
          input.style.padding = '6px';
          input.style.fontSize = '14px';
          input.style.boxSizing = 'border-box';
          input.placeholder = document.querySelectorAll('.ferramentaria-table th')[idx].textContent;
          // Força abrir o calendário ao clicar
          input.addEventListener('click', function(e) {
            this.showPicker && this.showPicker();
          });
          td.appendChild(input);
        } else if (campo === 'setor') {
          const select = document.createElement('select');
          select.style.width = '100%';
          select.style.padding = '6px';
          select.style.fontSize = '14px';
          select.style.boxSizing = 'border-box';
          select.style.borderRadius = '6px';
          select.style.border = '1px solid #ccc';
          const opcoes = ['', 'PCP', 'Qualidade', 'Produção', 'Diretoria', 'Ferramentaria'];
          opcoes.forEach(op => {
            const option = document.createElement('option');
            option.value = op;
            option.textContent = op ? op : 'Selecione...';
            select.appendChild(option);
          });
          td.appendChild(select);
        } else if (campo === 'status') {
          const select = document.createElement('select');
          select.style.width = '100%';
          select.style.padding = '6px';
          select.style.fontSize = '14px';
          select.style.boxSizing = 'border-box';
          select.style.borderRadius = '6px';
          select.style.border = '1px solid #ccc';
          const opcoes = ['', 'Liberada', 'Em Andamento', 'Concluído'];
          opcoes.forEach(op => {
            const option = document.createElement('option');
            option.value = op;
            option.textContent = op ? op : 'Selecione...';
            select.appendChild(option);
          });
          td.appendChild(select);
        } else if (campo === 'abertura') {
          let input = document.createElement('input');
          input.type = 'date';
          input.style.width = '100%';
          input.style.padding = '6px';
          input.style.fontSize = '14px';
          input.style.boxSizing = 'border-box';
          input.disabled = true;
          const hoje = new Date();
          input.value = hoje.toISOString().slice(0, 10);
          td.appendChild(input);
        } else {
          let input = document.createElement('input');
          input.type = 'text';
          input.style.width = '100%';
          input.style.padding = '6px';
          input.style.fontSize = '14px';
          input.style.boxSizing = 'border-box';
          input.placeholder = document.querySelectorAll('.ferramentaria-table th')[idx].textContent;
          td.appendChild(input);
        }
        linha.appendChild(td);
      });
      tabela.appendChild(linha);
      // Adiciona botão salvar
      const containerSalvar = document.getElementById('containerSalvar');
      containerSalvar.innerHTML = '';
      const btnSalvar = document.createElement('button');
      btnSalvar.id = 'btnSalvar';
      btnSalvar.textContent = 'Salvar';
      btnSalvar.style.padding = '8px 18px';
      btnSalvar.style.fontSize = '15px';
      btnSalvar.style.border = 'none';
      btnSalvar.style.borderRadius = '6px';
      btnSalvar.style.background = '#007bff';
      btnSalvar.style.color = '#fff';
      btnSalvar.style.fontWeight = 'bold';
      btnSalvar.style.cursor = 'pointer';
      btnSalvar.style.transition = 'background 0.2s';
      containerSalvar.appendChild(btnSalvar);
      // Botão cancelar
      const btnCancelar = document.createElement('button');
      btnCancelar.id = 'btnCancelar';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.style.padding = '8px 18px';
      btnCancelar.style.fontSize = '15px';
      btnCancelar.style.border = 'none';
      btnCancelar.style.borderRadius = '6px';
      btnCancelar.style.background = '#dc3545';
      btnCancelar.style.color = '#fff';
      btnCancelar.style.fontWeight = 'bold';
      btnCancelar.style.cursor = 'pointer';
      btnCancelar.style.transition = 'background 0.2s';
      btnCancelar.style.marginLeft = '10px';
      containerSalvar.appendChild(btnCancelar);
      btnSalvar.addEventListener('click', function() {
        // Captura os valores dos campos
        const campos = ['os', 'abertura', 'peca', 'molde', 'obs', 'setor', 'limite', 'status'];
        const dados = {};
        linha.childNodes.forEach((td, idx) => {
          if (campos[idx] === 'obs') {
            const btnObs = td.querySelector('button');
            dados[campos[idx]] = btnObs ? (btnObs.dataset.obs || '') : '';
          } else if (campos[idx] === 'setor' || campos[idx] === 'status') {
            const select = td.querySelector('select');
            dados[campos[idx]] = select ? select.value : '';
          } else if (campos[idx] === 'limite' || campos[idx] === 'abertura') {
            const input = td.querySelector('input[type="date"]');
            dados[campos[idx]] = input ? input.value : '';
          } else {
            const input = td.querySelector('input');
            dados[campos[idx]] = input ? input.value : '';
          }
        });
        // Envia os dados para o backend
        fetch('/api/ferramentaria', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        })
        .then(res => res.json())
        .then(json => {
          alert(json.message || 'Salvo com sucesso!');
        })
        .catch(() => {
          alert('Erro ao salvar!');
        });
        // Substitui a linha de inputs por uma linha de texto
        linha.innerHTML = campos.map((campo, idx) => {
          if (campo === 'obs') {
            return `<td><button class='btnAbrirObs' style='padding:6px 12px;font-size:14px;border:none;border-radius:6px;background:#ffc107;color:#222;font-weight:bold;cursor:pointer;'>Abrir</button></td>`;
          }
          return `<td>${dados[campo]}</td>`;
        }).join('');
        linha.id = '';
        containerSalvar.innerHTML = '';
        // Adiciona evento ao botão Abrir Obs
        const btnAbrirObs = linha.querySelector('.btnAbrirObs');
        if (btnAbrirObs) {
          btnAbrirObs.addEventListener('click', function() {
            let modal = document.getElementById('modalObs');
            if (!modal) {
              modal = document.createElement('div');
              modal.id = 'modalObs';
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100vw';
              modal.style.height = '100vh';
              modal.style.background = 'rgba(0,0,0,0.3)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';
              const box = document.createElement('div');
              box.style.background = '#fff';
              box.style.borderRadius = '12px';
              box.style.padding = '24px';
              box.style.boxShadow = '0 2px 16px rgba(0,0,0,0.18)';
              box.style.minWidth = '540px';
              box.style.maxWidth = '98vw';
              box.style.display = 'flex';
              box.style.flexDirection = 'column';
              box.style.gap = '16px';
              const label = document.createElement('label');
              label.textContent = 'Observação:';
              label.style.fontWeight = 'bold';
              label.style.marginBottom = '8px';
              const textoObs = document.createElement('div');
              textoObs.style.width = '100%';
              textoObs.style.minHeight = '120px';
              textoObs.style.fontSize = '15px';
              textoObs.style.padding = '8px';
              textoObs.style.borderRadius = '6px';
              textoObs.style.border = '1px solid #ccc';
              textoObs.style.background = '#f8f9fa';
              textoObs.style.whiteSpace = 'pre-wrap';
              textoObs.textContent = valores[4];
              const btnFecharObs = document.createElement('button');
              btnFecharObs.textContent = 'Fechar';
              btnFecharObs.style.padding = '8px 18px';
              btnFecharObs.style.fontSize = '15px';
              btnFecharObs.style.border = 'none';
              btnFecharObs.style.borderRadius = '6px';
              btnFecharObs.style.background = '#dc3545';
              btnFecharObs.style.color = '#fff';
              btnFecharObs.style.fontWeight = 'bold';
              btnFecharObs.style.cursor = 'pointer';
              btnFecharObs.style.transition = 'background 0.2s';
              btnFecharObs.style.marginLeft = '10px';
              const btns = document.createElement('div');
              btns.style.display = 'flex';
              btns.style.justifyContent = 'flex-end';
              btns.appendChild(btnFecharObs);
              box.appendChild(label);
              box.appendChild(textoObs);
              box.appendChild(btns);
              modal.appendChild(box);
              document.body.appendChild(modal);
              btnFecharObs.onclick = () => modal.remove();
            }
          });
        }
      });
      btnCancelar.addEventListener('click', function() {
        linha.remove();
        containerSalvar.innerHTML = '';
      });
    });
  </script>
</body>
</html>
