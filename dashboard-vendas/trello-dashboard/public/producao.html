<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Trello Estilizado</title>
  <style>
    .campos-personalizados {
      font-size: 14px;
      color: #333;
      margin-top: 2px;
      word-break: break-word;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 24px;
      background: #e9f3fa;
      border-radius: 6px;
      padding: 8px 10px;
    }

    .campos-destaque {
      background: #e3f2fd;
      border: 2px solid #b4d9f7;
      border-radius: 6px;
      padding: 6px 10px;
      margin-bottom: 16px;
      font-weight: bold;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 60px;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f4f5f7;
      margin: 0;
      font-size: 13px;
      display: flex;
    }
      /* Responsividade para telas menores */
    @media (max-width: 1500px) {
      .card-title {
        margin-bottom: 6px !important;
      }
      .campos-personalizados {
        margin-top: 6px !important;
      }
      .labels {
        margin-bottom: 4px !important;
      }
      .card-title {
        margin-top: 6px !important;
      }
      .card-status,
      .card-title,
      .labels,
      .campos-destaque {
        margin-bottom: 6px !important;
      }
        .campos-destaque {
          display: flex !important;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          gap: 18px;
          font-size: 11px !important;
        }
      .datas-campo span {
        font-size: 11px !important;
      }
      .campos-destaque {
        display: flex !important;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        font-size: 11px !important;
      }
      .campos-destaque {
        font-size: 11px !important;
      }
      .campos-personalizados {
        font-size: 11px !important;
      }
      .label {
        font-size: 12px !important;
      }
      .main-content {
        padding: 10px;
        background: #f7f3e6;
      }
      .dashboard-row {
        gap: 6px;
      }
      .lista {
        padding: 4px;
      }
      .card {
        padding: 12px !important;
        width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box !important;
      }
      .lista-titulo {
        font-size: 10px !important;
        padding: 6px 0;
      }
      .card-title {
        font-size: 12px !important;
      }
    }

    /* SIDEBAR */
    .sidebar {
      width: 220px;
      background: #fff;
      color: #222e3c;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 24px 0 0 0;
      box-shadow: 2px 0 8px rgba(0,0,0,0.08);
      z-index: 10;
      transition: width 0.3s;
      overflow: hidden;
    }
    .sidebar.closed {
      width: 60px;
    }
    .sidebar .logo {
      width: 100%;
      text-align: center;
      margin-bottom: 24px;
      transition: all 0.3s;
    }
    .sidebar .logo img {
      width: 140px;
      transition: width 0.3s, opacity 0.3s;
    }
    .sidebar.closed .logo img {
      display: none;
    }
    .sidebar nav {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-left: 24px;
      transition: all 0.3s;
    }
    .sidebar a {
      color: #222e3c;
      text-decoration: none;
      font-size: 15px;
      padding: 6px 0;
      border-radius: 4px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
    }
    .sidebar a:hover {
      background: #f4f5f7;
    }
    .sidebar a img {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      filter: grayscale(100%);
      transition: margin 0.3s, width 0.3s, height 0.3s;
    }
    .sidebar.closed nav {
      margin-left: 0;
      align-items: center;
    }
    .sidebar.closed nav a {
      justify-content: center;
      font-size: 0;
      padding: 8px 0;
    }
    .sidebar.closed nav a img {
      margin: 0;
      width: 24px;
      height: 24px;
      filter: grayscale(0%);
    }
    .sidebar-toggle {
      margin-top: auto;
      width: 100%;
      background: none;
      border: none;
      color: #222e3c;
      font-size: 22px;
      cursor: pointer;
      padding: 12px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      position: absolute;
      left: 0;
      bottom: 32px;
      border-radius: 0 0 0 8px;
    }
    .sidebar-toggle:hover {
      background: #f4f5f7;
    }
    .sidebar.closed .sidebar-toggle {
      width: 60px;
    }
    .main-content {
      margin-left: 220px;
      width: calc(100vw - 220px);
      padding: 20px;
      transition: margin-left 0.3s, width 0.3s;
    }
    .sidebar.closed ~ .main-content {
      margin-left: 60px;
      width: calc(100vw - 60px);
    }
    /* ...estilos originais da página... */
    h2 {
      margin-bottom: 10px;
      margin-left: 20px;
      font-size: 18px;
      text-align: left;
    }
    #dashboard {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .dashboard-row {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .lista {
      flex: 1 1 calc(100% / 5 - 12px);
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #ebecf0;
      padding: 8px;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .lista-titulo {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      text-align: center;
      color: #fff;
      background: linear-gradient(90deg, #007a3d 0%, #00b894 100%);
      border-radius: 6px;
      padding: 8px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card {
      padding: 20px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 4px;
      word-break: break-word;
      overflow: unset;
    }
    .card-title {
      margin-top: 15px;
      font-weight: bold;
      color: #172b4d;
      font-size: 17px;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .labels {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
    }
    .label {
      padding: 1px 3px;
      border-radius: 4px;
      font-size: 15px;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="sidebar closed" id="sidebar">
    <div class="logo">
      <img src="./logo.png" alt="Logo">
    </div>
    <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 0 24px 18px 24px;">
    <nav>
      <a href="./index.html">
        <img src="./icons/house-chimney.svg" alt="Dashboard">
        <span>Início</span>
      </a>
      <a href="./producao.html" id="producaoLink">
        <img src="./icons/industry-windows.svg" alt="Dashboard">
        <span>Painel Fabrica</span>
      </a>
      <a href="./vendas.html" id="vendasLink">
        <img src="./icons/search-dollar.svg" alt="Relatórios">
        <span>Vendas</span>
      </a>
    </nav>
    <button class="sidebar-toggle" id="sidebarToggle" title="Abrir/Fechar menu">
  <span id="toggleIcon">&gt;</span>
    </button>
  </div>
  <div class="main-content" id="mainContent">
  <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 10px; justify-content: space-between; position: relative;">
    <img src="logo.png" alt="Logo" style="height: 58px; margin-right: 18px; margin-left: 0;" />
  </div>
  <h2 style="margin-top: 30px">Sequência de Máquinas</h2>
  <div id="dashboard" style="margin-top: 30px"></div>

  <script>
    const labelColors = {
      green: '#61bd4f', yellow: '#f2d600', orange: '#ff9f1a', red: '#eb5a46',
      purple: '#c377e0', blue: '#0079bf', sky: '#00c2e0', lime: '#51e898',
      pink: '#ff78cb', black: '#344563'
    };

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadCards();
      setInterval(loadCards, 10000);
    });

    async function loadCards() {
      const boardId = 'eBApBIzf';

      try {
        const res = await fetch(`/cards/${boardId}`);
        if (!res.ok) throw new Error('Erro ao carregar cards');
        const cards = await res.json();

        const dashboard = document.getElementById('dashboard');
        dashboard.innerHTML = '';

        // Agrupa cards por lista
        const listasMap = {};
        cards.forEach(card => {
          if (!listasMap[card.listName]) listasMap[card.listName] = [];
          listasMap[card.listName].push(card);
        });

        // Ordena listas de INJ 1 a INJ 22
        const sortedListNames = Object.keys(listasMap)
          .sort((a,b) => parseInt(a.replace(/\D/g,''),10) - parseInt(b.replace(/\D/g,''),10));

  // Layout: quantidade de listas por linha
  const layout = [5,5,5,5,5];
  let index = 0;

  layout.forEach((count, rowIdx) => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'dashboard-row';

    // Última linha: INJ 21, INJ 22, vazio, vazio, vazio
    if (rowIdx === layout.length - 1) {
      // Busca INJ 21 e INJ 22
      const inj21 = sortedListNames.find(n => n.replace(/\D/g, '') === '21');
      const inj22 = sortedListNames.find(n => n.replace(/\D/g, '') === '22');
      const nomes = [inj21, inj22];
      for (let i = 0; i < 5; i++) {
        const listaDiv = document.createElement('div');
        listaDiv.className = 'lista';
        if (i < 2 && nomes[i]) {
          const titulo = document.createElement('div');
          titulo.className = 'lista-titulo';
          titulo.textContent = nomes[i];
          listaDiv.appendChild(titulo);
          listasMap[nomes[i]].slice(0,2).forEach(card => {
            // ...código de renderização do card...
            // Copiado do bloco original
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            let statusValue = '';
            if (card.customFields && card.customFields['Status']) {
              statusValue = card.customFields['Status'];
            }
            if (statusValue) {
              const statusDiv = document.createElement('div');
              statusDiv.className = 'card-status';
              statusDiv.textContent = `Status: ${statusValue}`;
              statusDiv.style.fontWeight = 'bold';
              statusDiv.style.color = '#0079bf';
              statusDiv.style.fontSize = '13px';
              statusDiv.style.marginBottom = '2px';
              cardDiv.appendChild(statusDiv);
            }
            if (card.customFields) {
              const topFieldsDiv = document.createElement('div');
              topFieldsDiv.className = 'campos-destaque';
              topFieldsDiv.style.marginBottom = '25px';
              ['OP', 'Ciclo'].forEach(campo => {
                const fieldDiv = document.createElement('div');
                let valor = card.customFields[campo];
                if (valor && typeof valor === 'string' && valor.length > 18) {
                  valor = valor.substring(0, 15) + '...';
                }
                fieldDiv.textContent = `${campo}: ${valor ?? 'N/A'}`;
                topFieldsDiv.appendChild(fieldDiv);
              });
              cardDiv.appendChild(topFieldsDiv);
            }
            const labelsDiv = document.createElement('div');
            labelsDiv.className = 'labels';
            (card.labels || []).forEach(l => {
              const span = document.createElement('span');
              span.className = 'label';
              span.textContent = l.name || '';
              span.style.backgroundColor = labelColors[l.color] || '#888';
              labelsDiv.appendChild(span);
            });
            cardDiv.appendChild(labelsDiv);
            const titleDiv = document.createElement('div');
            titleDiv.className = 'card-title';
            titleDiv.textContent = escapeHtml(card.name);
            cardDiv.appendChild(titleDiv);
            let customFieldsDiv = null;
            if (card.customFields && Object.keys(card.customFields).length > 0) {
              customFieldsDiv = document.createElement('div');
              customFieldsDiv.className = 'campos-personalizados';
              customFieldsDiv.style.marginTop = '25px';
              const camposOrdem = [
                ['Molde', 'Material'],
                ['Cor', 'Quantidade'],
                ['Produção', 'N° Pedido']
              ];
              camposOrdem.forEach(par => {
                par.forEach(campo => {
                  const fieldDiv = document.createElement('div');
                  let valor = card.customFields[campo];
                  if (valor && typeof valor === 'string' && valor.length > 18) {
                    valor = valor.substring(0, 15) + '...';
                  }
                  fieldDiv.textContent = `${campo}: ${valor ?? 'N/A'}`;
                  customFieldsDiv.appendChild(fieldDiv);
                });
              });
              cardDiv.appendChild(customFieldsDiv);
            }
            function abreviarAno(dataStr) {
              if (!dataStr || dataStr === 'N/A') return dataStr;
              const partes = dataStr.split('/');
              if (partes.length === 3) {
                partes[2] = partes[2].slice(-2);
                return partes.join('/');
              }
              return dataStr;
            }
            const dataInicio = card.startDate ? abreviarAno(new Date(card.startDate).toLocaleDateString('pt-BR')) : 'N/A';
            const dataFim = card.dueDate ? abreviarAno(new Date(card.dueDate).toLocaleDateString('pt-BR')) : 'N/A';
            const datasDiv = document.createElement('div');
            datasDiv.className = 'datas-campo';
            datasDiv.style.marginTop = '12px';
            datasDiv.style.fontSize = '14px';
            datasDiv.style.color = '#333';
            datasDiv.style.display = 'flex';
            datasDiv.style.gap = '10px';
            datasDiv.style.alignItems = 'center';
            const inicioBloco = document.createElement('div');
            inicioBloco.style.display = 'flex';
            inicioBloco.style.flexDirection = 'column';
            inicioBloco.style.alignItems = 'flex-start';
            const inicioLabel = document.createElement('span');
            inicioLabel.textContent = 'Inic:';
            inicioLabel.style.fontWeight = 'normal';
            const inicioSpan = document.createElement('span');
            inicioSpan.textContent = dataInicio;
            inicioSpan.style.border = '2px solid #8fd19e';
            inicioSpan.style.background = '#eafbe5';
            inicioSpan.style.borderRadius = '6px';
            inicioSpan.style.padding = '2px 10px';
            inicioSpan.style.fontWeight = 'bold';
            inicioBloco.appendChild(inicioLabel);
            inicioBloco.appendChild(inicioSpan);
            const fimBloco = document.createElement('div');
            fimBloco.style.display = 'flex';
            fimBloco.style.flexDirection = 'column';
            fimBloco.style.alignItems = 'flex-start';
            const fimLabel = document.createElement('span');
            fimLabel.textContent = 'Fim:';
            fimLabel.style.fontWeight = 'normal';
            const fimSpan = document.createElement('span');
            fimSpan.textContent = dataFim;
            fimSpan.style.border = '2px solid #8fd19e';
            fimSpan.style.borderRadius = '6px';
            fimSpan.style.padding = '2px 10px';
            fimSpan.style.fontWeight = 'bold';
            let corFundoFim = '#eafbe5';
            if (card.dueDate) {
              const hoje = new Date();
              hoje.setHours(0,0,0,0);
              const fimDate = new Date(card.dueDate);
              fimDate.setHours(0,0,0,0);
              const diffDias = Math.floor((fimDate - hoje) / (1000*60*60*24));
              if (diffDias === 0) {
                corFundoFim = '#ffd6d6';
                fimSpan.style.border = '2px solid #e57373';
              } else if (diffDias === 1) {
                corFundoFim = '#fff9c4';
                fimSpan.style.border = '2px solid #ffe082';
              }
            }
            fimSpan.style.background = corFundoFim;
            fimBloco.appendChild(fimLabel);
            fimBloco.appendChild(fimSpan);
            datasDiv.appendChild(inicioBloco);
            datasDiv.appendChild(fimBloco);
            cardDiv.appendChild(datasDiv);
            listaDiv.appendChild(cardDiv);
          });
        } else {
          // Espaço vazio
          listaDiv.innerHTML = '';
        }
        rowDiv.appendChild(listaDiv);
      }
      dashboard.appendChild(rowDiv);
      return;
    }

    // Demais linhas (original)
    for(let i=0; i<count; i++){
      if(index >= sortedListNames.length) break;
      const listName = sortedListNames[index];
      const listaDiv = document.createElement('div');
      listaDiv.className = 'lista';
      const titulo = document.createElement('div');
      titulo.className = 'lista-titulo';
      titulo.textContent = listName;
      listaDiv.appendChild(titulo);
      listasMap[listName].slice(0,2).forEach(card => {
        // ...código de renderização do card...
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card';
        let statusValue = '';
        if (card.customFields && card.customFields['Status']) {
          statusValue = card.customFields['Status'];
        }
        if (statusValue) {
          const statusDiv = document.createElement('div');
          statusDiv.className = 'card-status';
          statusDiv.textContent = `Status: ${statusValue}`;
          statusDiv.style.fontWeight = 'bold';
          statusDiv.style.color = '#0079bf';
          statusDiv.style.fontSize = '13px';
          statusDiv.style.marginBottom = '2px';
          cardDiv.appendChild(statusDiv);
        }
        if (card.customFields) {
          const topFieldsDiv = document.createElement('div');
          topFieldsDiv.className = 'campos-destaque';
          topFieldsDiv.style.marginBottom = '25px';
          ['OP', 'Ciclo'].forEach(campo => {
            const fieldDiv = document.createElement('div');
            let valor = card.customFields[campo];
            if (valor && typeof valor === 'string' && valor.length > 18) {
              valor = valor.substring(0, 15) + '...';
            }
            fieldDiv.textContent = `${campo}: ${valor ?? 'N/A'}`;
            topFieldsDiv.appendChild(fieldDiv);
          });
          cardDiv.appendChild(topFieldsDiv);
        }
        const labelsDiv = document.createElement('div');
        labelsDiv.className = 'labels';
        (card.labels || []).forEach(l => {
          const span = document.createElement('span');
          span.className = 'label';
          span.textContent = l.name || '';
          span.style.backgroundColor = labelColors[l.color] || '#888';
          labelsDiv.appendChild(span);
        });
        cardDiv.appendChild(labelsDiv);
        const titleDiv = document.createElement('div');
        titleDiv.className = 'card-title';
        titleDiv.textContent = escapeHtml(card.name);
        cardDiv.appendChild(titleDiv);
        let customFieldsDiv = null;
        if (card.customFields && Object.keys(card.customFields).length > 0) {
          customFieldsDiv = document.createElement('div');
          customFieldsDiv.className = 'campos-personalizados';
          customFieldsDiv.style.marginTop = '25px';
          const camposOrdem = [
            ['Molde', 'Material'],
            ['Cor', 'Quantidade'],
            ['Produção', 'N° Pedido']
          ];
          camposOrdem.forEach(par => {
            par.forEach(campo => {
              const fieldDiv = document.createElement('div');
              let valor = card.customFields[campo];
              if (valor && typeof valor === 'string' && valor.length > 18) {
                valor = valor.substring(0, 15) + '...';
              }
              fieldDiv.textContent = `${campo}: ${valor ?? 'N/A'}`;
              customFieldsDiv.appendChild(fieldDiv);
            });
          });
          cardDiv.appendChild(customFieldsDiv);
        }
        function abreviarAno(dataStr) {
          if (!dataStr || dataStr === 'N/A') return dataStr;
          const partes = dataStr.split('/');
          if (partes.length === 3) {
            partes[2] = partes[2].slice(-2);
            return partes.join('/');
          }
          return dataStr;
        }
        const dataInicio = card.startDate ? abreviarAno(new Date(card.startDate).toLocaleDateString('pt-BR')) : 'N/A';
        const dataFim = card.dueDate ? abreviarAno(new Date(card.dueDate).toLocaleDateString('pt-BR')) : 'N/A';
        const datasDiv = document.createElement('div');
        datasDiv.className = 'datas-campo';
        datasDiv.style.marginTop = '12px';
        datasDiv.style.fontSize = '14px';
        datasDiv.style.color = '#333';
        datasDiv.style.display = 'flex';
        datasDiv.style.gap = '10px';
        datasDiv.style.alignItems = 'center';
        const inicioBloco = document.createElement('div');
        inicioBloco.style.display = 'flex';
        inicioBloco.style.flexDirection = 'column';
        inicioBloco.style.alignItems = 'flex-start';
        const inicioLabel = document.createElement('span');
        inicioLabel.textContent = 'Inic:';
        inicioLabel.style.fontWeight = 'normal';
        const inicioSpan = document.createElement('span');
        inicioSpan.textContent = dataInicio;
        inicioSpan.style.border = '2px solid #8fd19e';
        inicioSpan.style.background = '#eafbe5';
        inicioSpan.style.borderRadius = '6px';
        inicioSpan.style.padding = '2px 10px';
        inicioSpan.style.fontWeight = 'bold';
        inicioBloco.appendChild(inicioLabel);
        inicioBloco.appendChild(inicioSpan);
        const fimBloco = document.createElement('div');
        fimBloco.style.display = 'flex';
        fimBloco.style.flexDirection = 'column';
        fimBloco.style.alignItems = 'flex-start';
        const fimLabel = document.createElement('span');
        fimLabel.textContent = 'Fim:';
        fimLabel.style.fontWeight = 'normal';
        const fimSpan = document.createElement('span');
        fimSpan.textContent = dataFim;
        fimSpan.style.border = '2px solid #8fd19e';
        fimSpan.style.borderRadius = '6px';
        fimSpan.style.padding = '2px 10px';
        fimSpan.style.fontWeight = 'bold';
        let corFundoFim = '#eafbe5';
        if (card.dueDate) {
          const hoje = new Date();
          hoje.setHours(0,0,0,0);
          const fimDate = new Date(card.dueDate);
          fimDate.setHours(0,0,0,0);
          const diffDias = Math.floor((fimDate - hoje) / (1000*60*60*24));
          if (diffDias === 0) {
            corFundoFim = '#ffd6d6';
            fimSpan.style.border = '2px solid #e57373';
          } else if (diffDias === 1) {
            corFundoFim = '#fff9c4';
            fimSpan.style.border = '2px solid #ffe082';
          }
        }
        fimSpan.style.background = corFundoFim;
        fimBloco.appendChild(fimLabel);
        fimBloco.appendChild(fimSpan);
        datasDiv.appendChild(inicioBloco);
        datasDiv.appendChild(fimBloco);
        cardDiv.appendChild(datasDiv);
        listaDiv.appendChild(cardDiv);
      });
      rowDiv.appendChild(listaDiv);
      index++;
    }
    dashboard.appendChild(rowDiv);
  });

      } catch (err) {
        console.error(err);
        alert('Erro: ' + (err.message || err));
      }
    }

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggle');
    const toggleIcon = document.getElementById('toggleIcon');

    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('closed');
      toggleIcon.innerHTML = sidebar.classList.contains('closed') ? '&gt;' : '&lt;';
    });
  </script>
</body>
</html>